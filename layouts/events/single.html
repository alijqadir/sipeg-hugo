{{ define "main" }}
{{ $start := .Params.event_start | time | dateFormat "20060102T150405Z" }}
{{ $end := .Params.event_end | default .Params.event_start | time | dateFormat "20060102T150405Z" }}
{{ $text := .Title | urlquery }}
{{ $details := (.Params.summary | default .Summary) | urlquery }}
{{ $location := .Params.location | urlquery }}
{{ $gcal := printf "https://www.google.com/calendar/render?action=TEMPLATE&text=%s&dates=%s/%s&details=%s&location=%s&sf=true&output=xml" $text $start $end $details $location }}
<main class="event-single">
  {{ $endpoint := or .Params.registration_endpoint .Site.Params.event_registration_endpoint }}
  <div class="event-single__wrapper">
    <header class="event-header">
      <h1>{{ .Title }}</h1>
      <p class="event-meta">
        {{ with .Params.event_start }}<span>{{ . | time | dateFormat "02 Jan 2006, 15:04" }}</span>{{ end }}
        {{ with .Params.location }}<span> • {{ . }}</span>{{ end }}
      </p>
      {{ with .Params.summary }}<p class="event-summary">{{ . }}</p>{{ end }}
    </header>
    {{ with .Params.image }}
    <figure class="event-hero__media">
      <img src="{{ . }}" alt="{{ $.Title }} visual" loading="lazy" decoding="async">
    </figure>
    {{ end }}

    <section class="event-body content">
      {{ .Content }}
    </section>

    <section class="event-actions">
      <a class="btn btn-primary" href="{{ $gcal }}" target="_blank" rel="noopener">Add to Google Calendar</a>
      <a class="btn btn-outline" href="{{ .RelPermalink }}event.ics">Download .ics</a>
      {{ if $endpoint }}
        <a class="btn btn-navy" href="#event-register">Request Invite</a>
      {{ else if .Params.registration_url }}
        <a class="btn btn-navy" href="{{ .Params.registration_url }}" target="_blank" rel="noopener">Join / Register</a>
      {{ end }}
    </section>

    {{ if $endpoint }}
    <section class="event-register" id="event-register" data-register-section tabindex="-1">
      <h3>Request an invite</h3>
      <p class="event-register__note" data-event-note>Enter your details to get the official Google Calendar invite and conferencing link. We first archive your RSVP on our server, then sync it to Google/Zoom.</p>
      <form class="event-register__form" data-event-form action="{{ $endpoint }}" method="post">
        <label>
          Name
          <input type="text" name="name" required>
        </label>
        <label>
          Email
          <input type="email" name="email" required>
        </label>
        <input type="text" name="hp_field" class="event-register__hp" autocomplete="off">
        <input type="hidden" name="event_title" value="{{ $.Title }}">
        <input type="hidden" name="event_url" value="{{ $.Permalink }}">
        <input type="hidden" name="event_key" value="{{ $.File.BaseFileName }}">
        <input type="hidden" name="event_start" value="{{ $.Params.event_start }}">
        <input type="hidden" name="event_end" value="{{ $.Params.event_end }}">
        <input type="hidden" name="event_location" value="{{ $.Params.location }}">
        <input type="hidden" name="gcal_calendar_id" value="{{ $.Params.gcal_calendar_id }}">
        <input type="hidden" name="gcal_event_id" value="{{ $.Params.gcal_event_id }}">
        {{ with $.Params.registration_url }}<input type="hidden" name="event_join_link" value="{{ . }}">{{ end }}
        {{ with $.Params.zoom_meeting_id }}<input type="hidden" name="zoom_meeting_id" value="{{ . }}">{{ end }}
        <button class="btn btn-primary" type="submit">Send me an invite</button>
        <div class="event-register__status" data-event-status></div>
      </form>
      <div class="event-register__success" data-event-success hidden tabindex="-1">
        <h4>Invite requested</h4>
        <p>Your RSVP was captured. We’re sending you a calendar invitation and conferencing details from SIPEG shortly.</p>
      </div>
    </section>
    {{ end }}
  </div>
</main>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('[data-event-form]');
    if (!form) return;
    const status = form.querySelector('[data-event-status]');
    const wrapper = form.closest('.event-register') || document;
    const success = wrapper.querySelector('[data-event-success]');
    const note = wrapper.querySelector('[data-event-note]');

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const hp = form.querySelector('.event-register__hp');
      if (hp && hp.value) return;
      status.textContent = 'Sending...';
      const data = new FormData(form);
      try {
        const res = await fetch(form.action, {
          method: 'POST',
          body: data,
        });
        const text = await res.text();
        if (!res.ok || text.toLowerCase().includes('error')) {
          throw new Error(text || 'Failed to send');
        }
        form.reset();
        form.classList.add('is-success');
        if (status) status.textContent = '';
        if (success) {
          success.hidden = false;
          success.classList.add('is-visible');
          success.focus();
        }
        if (note) {
          note.classList.add('is-hidden');
        }
      } catch (err) {
        status.textContent = 'Unable to send invite right now.';
        console.error(err);
      }
    });
  });
</script>
{{ end }}
