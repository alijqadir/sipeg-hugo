{{ define "main" }}
<section class="wrap research-list">
  <header class="section">
    <h1 class="h1">Research</h1>
    <p class="lead">Browse publications by author, year, and topic. Use the controls below to refine results.</p>
  </header>

  {{ $defaultSort := .Site.Params.research.defaultSort | default "year_desc" }}
  {{ $pages := .Pages }}
  {{ if eq $defaultSort "year_desc" }}
    {{ $pages = sort $pages "Params.year" "desc" }}
  {{ else if eq $defaultSort "year_asc" }}
    {{ $pages = sort $pages "Params.year" "asc" }}
  {{ else if eq $defaultSort "title_asc" }}
    {{ $pages = sort $pages "Title" "asc" }}
  {{ else if eq $defaultSort "title_desc" }}
    {{ $pages = sort $pages "Title" "desc" }}
  {{ else if eq $defaultSort "author_asc" }}
    {{ $pages = sort $pages "Params.authors" "asc" }}
  {{ else if eq $defaultSort "author_desc" }}
    {{ $pages = sort $pages "Params.authors" "desc" }}
  {{ end }}

  {{ $years := slice }}
  {{ $topics := slice }}
  {{ $focusAreas := slice }}
  {{ $programs := sort (where .Site.RegularPages "Section" "programs") "Params.weight" "asc" }}
  {{ range $programs }}
    {{ $key := .Params.focus_key | default .File.TranslationBaseName }}
    {{ if $key }}{{ $focusAreas = $focusAreas | append (dict "key" $key "title" .Title) }}{{ end }}
  {{ end }}
  {{ range $pages }}
    {{ with .Params.year }}{{ $years = $years | append . }}{{ end }}
    {{ with .Params.topics }}{{ range . }}{{ $topics = $topics | append . }}{{ end }}{{ end }}
  {{ end }}
  {{ $years = sort (uniq $years) "value" "desc" }}
  {{ $topics = sort (uniq $topics) }}

  <div class="filters-bar">
    <div class="filters-bar__search">
      <label class="sr-only" for="filter-search">Search publications</label>
      <input type="search" id="filter-search" placeholder="Search title, abstract, or author" autocomplete="off">
    </div>
    <div class="filters-bar__controls">
      <label class="sr-only" for="research-sort">Sort research</label>
      <select id="research-sort" class="select" data-default="{{ $defaultSort }}">
        <option value="year_desc" {{ if eq $defaultSort "year_desc" }}selected{{ end }}>Newest → Oldest</option>
        <option value="year_asc" {{ if eq $defaultSort "year_asc" }}selected{{ end }}>Oldest → Newest</option>
        <option value="title_asc" {{ if eq $defaultSort "title_asc" }}selected{{ end }}>Title A–Z</option>
        <option value="title_desc" {{ if eq $defaultSort "title_desc" }}selected{{ end }}>Title Z–A</option>
        <option value="author_asc" {{ if eq $defaultSort "author_asc" }}selected{{ end }}>Author A–Z</option>
        <option value="author_desc" {{ if eq $defaultSort "author_desc" }}selected{{ end }}>Author Z–A</option>
        <option value="topic_asc" {{ if eq $defaultSort "topic_asc" }}selected{{ end }}>Topic A–Z</option>
        <option value="topic_desc" {{ if eq $defaultSort "topic_desc" }}selected{{ end }}>Topic Z–A</option>
      </select>
      <button type="button" class="btn btn-outline filters-bar__toggle" id="filters-toggle" aria-expanded="false" aria-controls="filters-panel">Filters</button>
    </div>
  </div>

  <div id="filters-panel" class="filters-panel" hidden>
    <div class="filters-panel__backdrop" data-filters-backdrop></div>
    <div class="filters-panel__content" role="dialog" aria-modal="true" aria-labelledby="filters-title">
      <header class="filters-panel__header">
        <h2 id="filters-title">Refine research</h2>
        <button type="button" class="filters-panel__close" data-filters-close>Close</button>
      </header>
      <div class="filters-panel__body">
        <section class="filters-section">
          <h3>Author</h3>
          <input type="search" id="filter-author" placeholder="Search by author" autocomplete="off" data-filters-initial>
        </section>
        <section class="filters-section">
          <h3>Years</h3>
          <div class="filters-section__list filters-section__list--columns">
            {{ range $years }}
              <label>
                <input type="checkbox" value="{{ . }}" data-filter-year>
                <span>{{ . }}</span>
              </label>
            {{ end }}
          </div>
        </section>
        <section class="filters-section">
          <h3>Topics</h3>
          <div class="filters-section__tags">
            {{ range $topics }}
              {{ $value := lower . }}
              <label>
                <input type="checkbox" value="{{ $value }}" data-filter-topic>
                <span>{{ . }}</span>
              </label>
            {{ end }}
          </div>
        </section>
        <section class="filters-section">
          <h3>Focus areas</h3>
          <div class="filters-section__tags">
            {{ range $focusAreas }}
              <label>
                <input type="checkbox" value="{{ .key }}" data-filter-focus>
                <span>{{ .title }}</span>
              </label>
            {{ end }}
          </div>
        </section>
      </div>
      <footer class="filters-panel__footer">
        <button type="button" class="btn btn-outline" id="filters-clear">Clear filters</button>
        <button type="button" class="btn btn-primary" data-filters-close>Apply filters</button>
      </footer>
    </div>
  </div>

  <p id="filters-summary" class="filters-summary"></p>
  <p id="no-results" class="filters-empty" hidden>No publications match your filters yet. Adjust your selections to see more research.</p>

  <div id="research-grid" class="research-grid">
    {{ range $pages }}
      {{ partial "cards/research-card.html" . }}
    {{ end }}
  </div>
</section>

<script>
  (() => {
    const grid = document.getElementById('research-grid');
    if (!grid) return;

    let cards = Array.from(grid.querySelectorAll('.research-card'));
    const total = cards.length;

    const sortSelect = document.getElementById('research-sort');
    const searchInput = document.getElementById('filter-search');
    const authorInput = document.getElementById('filter-author');
    const yearInputs = Array.from(document.querySelectorAll('[data-filter-year]'));
    const topicInputs = Array.from(document.querySelectorAll('[data-filter-topic]'));
    const focusInputs = Array.from(document.querySelectorAll('[data-filter-focus]'));
    const clearBtn = document.getElementById('filters-clear');
    const summaryEl = document.getElementById('filters-summary');
    const emptyEl = document.getElementById('no-results');

    const toggleBtn = document.getElementById('filters-toggle');
    const panel = document.getElementById('filters-panel');
    const panelBackdrop = panel?.querySelector('[data-filters-backdrop]');
    const panelCloseButtons = panel ? Array.from(panel.querySelectorAll('[data-filters-close]')) : [];
    const initialFocus = panel?.querySelector('[data-filters-initial]');
    let lastFocus = null;

    const openPanel = () => {
      if (!panel) return;
      lastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      panel.hidden = false;
      panel.classList.add('is-open');
      toggleBtn?.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
      (initialFocus || panel).focus();
    };

    const closePanel = () => {
      if (!panel) return;
      panel.classList.remove('is-open');
      panel.hidden = true;
      toggleBtn?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
      if (lastFocus && typeof lastFocus.focus === 'function') {
        lastFocus.focus();
      }
    };

    toggleBtn?.addEventListener('click', () => {
      if (!panel) return;
      if (panel.classList.contains('is-open')) {
        closePanel();
      } else {
        openPanel();
      }
    });

    panelBackdrop?.addEventListener('click', closePanel);
    panelCloseButtons.forEach((btn) => btn.addEventListener('click', closePanel));
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && panel?.classList.contains('is-open')) {
        closePanel();
      }
    });

    const debounce = (fn, delay = 180) => {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    };

    const getActiveYears = () => yearInputs.filter((input) => input.checked).map((input) => input.value);
    const getActiveTopics = () => topicInputs.filter((input) => input.checked).map((input) => input.value.toLowerCase());
    const getActiveFocus = () => focusInputs.filter((input) => input.checked).map((input) => input.value);

    const compare = (mode) => {
      return (a, b) => {
        const ay = Number(a.dataset.year || 0);
        const by = Number(b.dataset.year || 0);
        const at = (a.dataset.title || '').toLowerCase();
        const bt = (b.dataset.title || '').toLowerCase();
        const aa = (a.dataset.author || '').toLowerCase();
        const ba = (b.dataset.author || '').toLowerCase();
        const atop = (a.dataset.topics || '').split('|')[0] || '';
        const btop = (b.dataset.topics || '').split('|')[0] || '';
        switch (mode) {
          case 'year_asc':
            return ay - by || at.localeCompare(bt);
          case 'title_asc':
            return at.localeCompare(bt);
          case 'title_desc':
            return bt.localeCompare(at);
          case 'author_asc':
            return aa.localeCompare(ba) || at.localeCompare(bt);
          case 'author_desc':
            return ba.localeCompare(aa) || at.localeCompare(bt);
          case 'topic_asc':
            return atop.localeCompare(btop) || at.localeCompare(bt);
          case 'topic_desc':
            return btop.localeCompare(atop) || at.localeCompare(bt);
          case 'year_desc':
          default:
            return by - ay || at.localeCompare(bt);
        }
      };
    };

    const applySort = (mode, updateURL = false) => {
      const sorted = [...cards].sort(compare(mode));
      sorted.forEach((card) => grid.appendChild(card));
      cards = sorted;
      if (updateURL) {
        const current = new URL(window.location.href);
        current.searchParams.set('sort', mode);
        window.history.replaceState({}, '', current);
      }
    };

    const applyFilters = () => {
      const searchTerm = (searchInput?.value || '').trim().toLowerCase();
      const authorTerm = (authorInput?.value || '').trim().toLowerCase();
      const activeYears = getActiveYears();
      const activeTopics = getActiveTopics();
      const activeFocus = getActiveFocus();
      let visible = 0;

      cards.forEach((card) => {
        const data = card.dataset;
        const haystack = `${data.title || ''} ${data.abstract || ''} ${data.topics || ''} ${data.authors || ''}`;
        const topics = (data.topics || '').split('|');
        const focusList = (data.focus || '').split('|').filter(Boolean);
        let show = true;

        if (searchTerm && !haystack.includes(searchTerm)) {
          show = false;
        }

        if (show && authorTerm && !(data.authors || '').includes(authorTerm)) {
          show = false;
        }

        if (show && activeYears.length && !activeYears.includes(data.year)) {
          show = false;
        }

        if (show && activeTopics.length) {
          const match = topics.some((topic) => activeTopics.includes(topic));
          if (!match) show = false;
        }

        if (show && activeFocus.length) {
          const matchFocus = focusList.some((f) => activeFocus.includes(f));
          if (!matchFocus) show = false;
        }

        card.classList.toggle('is-hidden', !show);
        if (show) visible += 1;
      });

      if (summaryEl) {
        const filtersActive = Boolean(searchTerm || authorTerm || activeYears.length || activeTopics.length || activeFocus.length);
        if (visible === total && !filtersActive) {
          summaryEl.textContent = `${total} publications available.`;
        } else {
          summaryEl.textContent = visible ? `${visible} of ${total} publications match your filters.` : 'No publications match your filters yet.';
        }
      }
      if (emptyEl) {
        emptyEl.hidden = visible > 0;
      }
    };

    const initFromURL = () => {
      const params = new URLSearchParams(window.location.search);
      const sortParam = params.get('sort');
      if (sortParam && sortSelect) {
        sortSelect.value = sortParam;
      }
    };

    const defaultSort = sortSelect?.dataset.default || 'year_desc';
    initFromURL();
    applySort(sortSelect?.value || defaultSort);
    applyFilters();

    const handleSortChange = () => {
      const mode = sortSelect.value;
      applySort(mode, true);
      applyFilters();
    };

    const handleInputChange = debounce(applyFilters);

    sortSelect?.addEventListener('change', handleSortChange);
    searchInput?.addEventListener('input', handleInputChange);
    authorInput?.addEventListener('input', handleInputChange);
    yearInputs.forEach((input) => input.addEventListener('change', applyFilters));
    topicInputs.forEach((input) => input.addEventListener('change', applyFilters));
    focusInputs.forEach((input) => input.addEventListener('change', applyFilters));

    clearBtn?.addEventListener('click', () => {
      if (searchInput) searchInput.value = '';
      if (authorInput) authorInput.value = '';
      yearInputs.forEach((input) => (input.checked = false));
      topicInputs.forEach((input) => (input.checked = false));
      focusInputs.forEach((input) => (input.checked = false));
      if (sortSelect) {
        sortSelect.value = defaultSort;
        applySort(defaultSort, true);
      }
      applyFilters();
    });
  })();
</script>
{{ end }}
